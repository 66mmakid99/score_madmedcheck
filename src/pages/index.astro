---
// src/pages/index.astro
// 인명사전 스타일 - 검증된 의료인 목록
import Layout from '../layouts/Layout.astro';
import { getD1, getAllDoctors, getStats } from '../lib/d1';
import type { Doctor } from '../lib/types';

// Cloudflare D1 바인딩 가져오기
const runtime = Astro.locals.runtime;
const db = getD1(runtime);

// URL 파라미터에서 필터/정렬 옵션 가져오기
const url = new URL(Astro.request.url);
const sortParam = url.searchParams.get('sort') || 'korean';
const regionParam = url.searchParams.get('region') || '';
const specialtyParam = url.searchParams.get('specialty') || '';
const searchParam = url.searchParams.get('q') || '';

// D1에서 데이터 조회
const doctors = await getAllDoctors(db, {
  sort: sortParam as 'korean' | 'english' | 'region' | 'specialty',
  region: regionParam || undefined,
  specialty: specialtyParam || undefined,
  search: searchParam || undefined,
});

const stats = await getStats(db);

// 지역 목록 (필터용)
const regions = [...new Set(doctors.map(d => d.region).filter(Boolean))].sort();
const specialties = ['피부과전문의', '성형외과전문의', '일반의', '타과전문의'];

// 레이더 데이터에서 가장 높은 영역 찾기
function getTopStrength(doctor: Doctor): string {
  const data = doctor.radar_chart_data;
  const entries = [
    { key: '학술', value: data.academic },
    { key: '임상', value: data.clinical },
    { key: '경력', value: data.career },
    { key: '안전', value: data.safety },
    { key: '활동', value: data.activity },
  ];
  const top = entries.sort((a, b) => b.value - a.value)[0];
  return top.key;
}

// 강점 영역 한글 설명
function getStrengthDescription(doctor: Doctor): string {
  const strength = getTopStrength(doctor);
  const typeDescriptions: Record<string, string> = {
    '학술': '학술 연구에 강점을 가진',
    '임상': '임상 경험이 풍부한',
    '경력': '오랜 경력을 갖춘',
    '안전': '안전한 시술을 추구하는',
    '활동': '활발한 학회 활동을 하는',
  };
  return typeDescriptions[strength] || '';
}
---

<Layout title="검증된 의료인 인명부 - MadMedCheck">
  <!-- Header Section -->
  <div class="mb-8">
    <div class="mb-6">
      <div class="text-sm text-mmc-secondary font-medium mb-1">
        Verified Medical Professionals
      </div>
      <h1 class="text-3xl md:text-4xl font-display font-black tracking-tight">
        검증된 의료인 인명부
      </h1>
      <p class="text-mmc-secondary mt-2">
        제3자 검증 데이터 기반 의료인 정보
      </p>
    </div>

    <!-- Stats Bar (점수/순위 제거) -->
    <div class="bg-mmc-surface rounded-lg border border-mmc-border p-4">
      <div class="grid grid-cols-3 gap-4 text-center">
        <div>
          <div class="text-2xl font-display font-bold">{stats.total}</div>
          <div class="text-mmc-secondary text-sm">검증된 의료인</div>
        </div>
        <div>
          <div class="text-2xl font-display font-bold">{regions.length}</div>
          <div class="text-mmc-secondary text-sm">지역</div>
        </div>
        <div>
          <div class="text-2xl font-display font-bold">Weekly</div>
          <div class="text-mmc-secondary text-sm">업데이트 주기</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Search & Filter Section -->
  <div class="bg-mmc-surface rounded-lg border border-mmc-border p-4 mb-6">
    <form method="GET" class="space-y-4">
      <!-- Search -->
      <div>
        <input
          type="text"
          name="q"
          placeholder="의료인 이름, 병원명으로 검색..."
          value={searchParam}
          class="w-full px-4 py-2.5 rounded-lg border border-mmc-border bg-mmc-bg text-mmc-text placeholder-mmc-secondary focus:outline-none focus:ring-2 focus:ring-mmc-accent"
        />
      </div>

      <!-- Filters -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        <!-- Sort -->
        <select
          name="sort"
          class="px-3 py-2 rounded-lg border border-mmc-border bg-mmc-bg text-mmc-text text-sm"
        >
          <option value="korean" selected={sortParam === 'korean'}>가나다순</option>
          <option value="english" selected={sortParam === 'english'}>ABC순</option>
          <option value="region" selected={sortParam === 'region'}>지역별</option>
          <option value="specialty" selected={sortParam === 'specialty'}>전문분야별</option>
        </select>

        <!-- Region Filter -->
        <select
          name="region"
          class="px-3 py-2 rounded-lg border border-mmc-border bg-mmc-bg text-mmc-text text-sm"
        >
          <option value="">전체 지역</option>
          {regions.map(region => (
            <option value={region} selected={regionParam === region}>{region}</option>
          ))}
        </select>

        <!-- Specialty Filter -->
        <select
          name="specialty"
          class="px-3 py-2 rounded-lg border border-mmc-border bg-mmc-bg text-mmc-text text-sm"
        >
          <option value="">전체 전문분야</option>
          {specialties.map(spec => (
            <option value={spec} selected={specialtyParam === spec}>{spec}</option>
          ))}
        </select>

        <!-- Search Button -->
        <button
          type="submit"
          class="px-4 py-2 bg-mmc-accent text-white rounded-lg text-sm font-semibold hover:bg-red-700 transition"
        >
          검색
        </button>
      </div>
    </form>
  </div>

  <!-- Results Count -->
  <div class="mb-4 text-sm text-mmc-secondary">
    총 <span class="font-semibold text-mmc-text">{doctors.length}</span>명의 검증된 의료인
  </div>

  <!-- Doctor Grid -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
    {doctors.map((doctor) => (
      <a
        href={`/doctor/${doctor.id}`}
        class="block bg-mmc-surface border border-mmc-border rounded-lg p-5 hover:border-mmc-accent hover:shadow-lg transition group"
      >
        <!-- Doctor Header -->
        <div class="flex items-start justify-between mb-3">
          <div>
            <h3 class="font-bold text-lg group-hover:text-mmc-accent transition">
              {doctor.doctor_name || '미공개'}
            </h3>
            {doctor.english_name && (
              <div class="text-xs text-mmc-secondary">{doctor.english_name}</div>
            )}
          </div>
          <span class="text-xs px-2 py-1 rounded bg-mmc-border text-mmc-secondary">
            {doctor.specialist_type}
          </span>
        </div>

        <!-- Hospital & Region -->
        <div class="text-sm text-mmc-secondary mb-4">
          <div>{doctor.hospital_name}</div>
          <div>{doctor.region} · 경력 {doctor.years_of_practice}년</div>
        </div>

        <!-- Strength Gauges (점수 대신 게이지 바) -->
        <div class="space-y-2 mb-4">
          <div class="flex items-center gap-2">
            <span class="text-xs text-mmc-secondary w-10">학술</span>
            <div class="flex-1 h-2 bg-mmc-border rounded-full overflow-hidden">
              <div
                class="h-full bg-blue-500 rounded-full"
                style={`width: ${doctor.radar_chart_data.academic}%`}
              ></div>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-xs text-mmc-secondary w-10">임상</span>
            <div class="flex-1 h-2 bg-mmc-border rounded-full overflow-hidden">
              <div
                class="h-full bg-green-500 rounded-full"
                style={`width: ${doctor.radar_chart_data.clinical}%`}
              ></div>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-xs text-mmc-secondary w-10">활동</span>
            <div class="flex-1 h-2 bg-mmc-border rounded-full overflow-hidden">
              <div
                class="h-full bg-purple-500 rounded-full"
                style={`width: ${doctor.radar_chart_data.activity}%`}
              ></div>
            </div>
          </div>
        </div>

        <!-- Strength Description -->
        <div class="text-sm text-mmc-accent">
          {getStrengthDescription(doctor)} {doctor.specialist_type}
        </div>
      </a>
    ))}
  </div>

  {doctors.length === 0 && (
    <div class="text-center py-20 text-mmc-secondary border border-mmc-border rounded-lg bg-mmc-surface">
      <p class="mb-2">검색 결과가 없습니다.</p>
      <a href="/" class="text-mmc-accent hover:underline">전체 목록 보기</a>
    </div>
  )}

  <!-- Data Source Notice -->
  <div class="mt-8 text-center">
    <p class="text-sm text-mmc-secondary">
      본 인명부는 SCI 논문, 제조사 인증, 학회 활동 등 제3자 검증 데이터만을 기반으로 합니다.
      <a href="/about" class="text-mmc-accent hover:underline">평가 기준 자세히 보기</a>
    </p>
  </div>

  <!-- CTA Section -->
  <section class="mt-12 bg-mmc-surface border border-mmc-border rounded-lg p-8 text-center">
    <h3 class="text-xl font-bold mb-2">의료인이신가요?</h3>
    <p class="text-mmc-secondary mb-4">객관적 데이터를 제출하고 인명부에 등재되세요.</p>
    <a
      href="/for-doctors"
      class="inline-block bg-mmc-accent text-white px-6 py-2.5 rounded-lg font-semibold hover:bg-red-700 transition"
    >
      데이터 제출하기
    </a>
  </section>
</Layout>
