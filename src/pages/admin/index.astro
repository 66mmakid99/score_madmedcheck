---
// src/pages/admin/index.astro
// ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ - í¬ë¡¤ë§ íŠ¸ë¦¬ê±° ë° ëª¨ë‹ˆí„°ë§

import Layout from '../../layouts/Layout.astro';
import { getD1, getTop100, getStats } from '../../lib/d1';

// D1 ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
const runtime = Astro.locals.runtime as { env?: { DB?: unknown } } | undefined;
const db = getD1(runtime);
const doctors = await getTop100(db);
const stats = await getStats(db);

// í¬ë¡¤ë§ ëŒ€ìƒ ì§€ì—­
const REGIONS = [
  { id: 'gangnam', name: 'ê°•ë‚¨ì—­', emoji: 'ğŸ™ï¸' },
  { id: 'cheongdam', name: 'ì²­ë‹´ì—­', emoji: 'âœ¨' },
  { id: 'sinsa', name: 'ì‹ ì‚¬ì—­', emoji: 'ğŸŒ³' },
  { id: 'apgujeong', name: 'ì••êµ¬ì •ì—­', emoji: 'ğŸ’' },
  { id: 'samsung', name: 'ì‚¼ì„±ì—­', emoji: 'ğŸ¢' },
];

const SPECIALTIES = [
  { id: 'derma', name: 'í”¼ë¶€ê³¼', emoji: 'ğŸ”¬' },
  { id: 'plastic', name: 'ì„±í˜•ì™¸ê³¼', emoji: 'ğŸ’‰' },
];

// í•™íšŒ ëª©ë¡
const CONFERENCES = [
  { id: 'kda', name: 'ëŒ€í•œí”¼ë¶€ê³¼í•™íšŒ', tier: 'tier1' },
  { id: 'prs-korea', name: 'ëŒ€í•œì„±í˜•ì™¸ê³¼í•™íšŒ', tier: 'tier1' },
  { id: 'ksaps', name: 'ëŒ€í•œë¯¸ìš©ì„±í˜•ì™¸ê³¼í•™íšŒ', tier: 'tier1' },
  { id: 'kaldat', name: 'ëŒ€í•œë ˆì´ì €í”¼ë¶€ëª¨ë°œí•™íšŒ', tier: 'tier2' },
];
---

<Layout title="ê´€ë¦¬ì" description="MadMedCheck ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ">
  <!-- ê´€ë¦¬ì í—¤ë” -->
  <div class="mb-8">
    <div class="flex items-center gap-2 text-sm text-mmc-secondary mb-2">
      <a href="/" class="hover:text-mmc-accent">HOME</a>
      <span>/</span>
      <span>ADMIN</span>
    </div>
    <h1 class="font-display font-black text-3xl">ADMIN DASHBOARD</h1>
    <p class="text-mmc-secondary mt-1">í¬ë¡¤ë§ ê´€ë¦¬ ë° ë°ì´í„° ëª¨ë‹ˆí„°ë§</p>
  </div>

  <!-- í†µê³„ ì¹´ë“œ -->
  <section class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
    <div class="bg-white rounded-xl border border-mmc-border p-4">
      <div class="text-3xl font-display font-black text-mmc-accent">{stats.total}</div>
      <div class="text-sm text-mmc-secondary">ë“±ë¡ ì˜ì‚¬</div>
    </div>
    <div class="bg-white rounded-xl border border-mmc-border p-4">
      <div class="text-3xl font-display font-black">{stats.avgScore}</div>
      <div class="text-sm text-mmc-secondary">í‰ê·  ì ìˆ˜</div>
    </div>
    <div class="bg-white rounded-xl border border-mmc-border p-4">
      <div class="text-3xl font-display font-black text-amber-500">{stats.tierCounts['Laureate'] || 0}</div>
      <div class="text-sm text-mmc-secondary">Laureate</div>
    </div>
    <div class="bg-white rounded-xl border border-mmc-border p-4">
      <div class="text-3xl font-display font-black text-purple-500">{stats.tierCounts['Authority'] || 0}</div>
      <div class="text-sm text-mmc-secondary">Authority</div>
    </div>
  </section>

  <!-- í¬ë¡¤ë§ ì»¨íŠ¸ë¡¤ -->
  <section class="bg-white rounded-xl border border-mmc-border p-6 mb-8">
    <h2 class="font-display font-bold text-xl mb-4">CRAWL CONTROL</h2>

    <!-- ì§€ì—­ë³„ í¬ë¡¤ë§ -->
    <div class="mb-6">
      <h3 class="text-sm font-semibold text-mmc-secondary mb-3">ì§€ì—­ ì„ íƒ</h3>
      <div class="flex flex-wrap gap-2">
        {REGIONS.map(region => (
          <button
            class="region-btn px-4 py-2 rounded-lg border border-mmc-border hover:border-mmc-accent hover:bg-mmc-accent/5 transition flex items-center gap-2"
            data-region={region.id}
          >
            <span>{region.emoji}</span>
            <span class="font-medium">{region.name}</span>
          </button>
        ))}
      </div>
    </div>

    <!-- ì§„ë£Œê³¼ ì„ íƒ -->
    <div class="mb-6">
      <h3 class="text-sm font-semibold text-mmc-secondary mb-3">ì§„ë£Œê³¼ ì„ íƒ</h3>
      <div class="flex flex-wrap gap-2">
        {SPECIALTIES.map(spec => (
          <button
            class="specialty-btn px-4 py-2 rounded-lg border border-mmc-border hover:border-mmc-accent hover:bg-mmc-accent/5 transition flex items-center gap-2"
            data-specialty={spec.id}
          >
            <span>{spec.emoji}</span>
            <span class="font-medium">{spec.name}</span>
          </button>
        ))}
      </div>
    </div>

    <!-- í¬ë¡¤ë§ ì‹¤í–‰ ë²„íŠ¼ -->
    <div class="flex flex-wrap gap-3">
      <button
        id="startCrawlBtn"
        class="px-6 py-3 bg-mmc-accent text-white font-bold rounded-lg hover:bg-mmc-accent/90 transition disabled:opacity-50"
      >
        í¬ë¡¤ë§ ì‹œì‘
      </button>
      <button
        id="stopCrawlBtn"
        class="px-6 py-3 bg-red-500 text-white font-bold rounded-lg hover:bg-red-600 transition disabled:opacity-50"
        disabled
      >
        ì¤‘ì§€
      </button>
    </div>

    <!-- ì§„í–‰ ìƒíƒœ -->
    <div id="crawlStatus" class="mt-4 hidden">
      <div class="bg-mmc-surface rounded-lg p-4">
        <div class="flex items-center gap-3 mb-2">
          <div class="animate-spin w-5 h-5 border-2 border-mmc-accent border-t-transparent rounded-full"></div>
          <span class="font-medium" id="statusText">í¬ë¡¤ë§ ì¤€ë¹„ ì¤‘...</span>
        </div>
        <div class="w-full bg-mmc-border rounded-full h-2">
          <div id="progressBar" class="bg-mmc-accent h-2 rounded-full transition-all" style="width: 0%"></div>
        </div>
        <div class="text-sm text-mmc-secondary mt-2" id="progressText">0 / 0</div>
      </div>
    </div>
  </section>

  <!-- í•™íšŒ í¬ë¡¤ë§ -->
  <section class="bg-white rounded-xl border border-mmc-border p-6 mb-8">
    <h2 class="font-display font-bold text-xl mb-4">CONFERENCE CRAWL</h2>
    <p class="text-sm text-mmc-secondary mb-4">í•™ìˆ ëŒ€íšŒ ë°œí‘œì ë°ì´í„° ìˆ˜ì§‘ (í•™ìˆ í™œë™ ì ìˆ˜ ì‚°ì •ìš©)</p>

    <div class="grid grid-cols-2 gap-3 mb-4">
      {CONFERENCES.map(conf => (
        <button
          class="conf-btn p-3 rounded-lg border border-mmc-border hover:border-mmc-accent hover:bg-mmc-accent/5 transition text-left"
          data-conference={conf.id}
        >
          <div class="font-medium text-sm">{conf.name}</div>
          <div class="text-xs text-mmc-secondary">{conf.tier}</div>
        </button>
      ))}
    </div>

    <button
      id="crawlConferenceBtn"
      class="px-6 py-3 bg-purple-500 text-white font-bold rounded-lg hover:bg-purple-600 transition"
    >
      í•™íšŒ ë°œí‘œì í¬ë¡¤ë§
    </button>
  </section>

  <!-- ìµœê·¼ ë“±ë¡ ì˜ì‚¬ -->
  <section class="bg-white rounded-xl border border-mmc-border p-6">
    <h2 class="font-display font-bold text-xl mb-4">RECENT DOCTORS</h2>

    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="border-b border-mmc-border">
            <th class="text-left py-3 px-2 font-semibold">#</th>
            <th class="text-left py-3 px-2 font-semibold">ë³‘ì›</th>
            <th class="text-left py-3 px-2 font-semibold">ì˜ì‚¬</th>
            <th class="text-left py-3 px-2 font-semibold">ì ìˆ˜</th>
            <th class="text-left py-3 px-2 font-semibold">ë“±ê¸‰</th>
          </tr>
        </thead>
        <tbody>
          {doctors.slice(0, 10).map((doc, i) => (
            <tr class="border-b border-mmc-border/50 hover:bg-mmc-surface/50">
              <td class="py-3 px-2 font-display font-bold text-mmc-secondary">{i + 1}</td>
              <td class="py-3 px-2">
                <a href={`/doctor/${doc.id}`} class="hover:text-mmc-accent">
                  {doc.hospital_name}
                </a>
              </td>
              <td class="py-3 px-2">{doc.doctor_name || '-'}</td>
              <td class="py-3 px-2 font-display font-bold">{doc.total_score}</td>
              <td class="py-3 px-2">
                <span class={`px-2 py-1 rounded text-xs font-bold ${
                  doc.tier === 'Laureate' ? 'bg-amber-100 text-amber-700' :
                  doc.tier === 'Authority' ? 'bg-purple-100 text-purple-700' :
                  doc.tier === 'Master' ? 'bg-blue-100 text-blue-700' :
                  'bg-gray-100 text-gray-700'
                }`}>
                  {doc.tier}
                </span>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  </section>
</Layout>

<script>
  // ì„ íƒëœ ì§€ì—­/ì§„ë£Œê³¼ ê´€ë¦¬
  let selectedRegions: string[] = [];
  let selectedSpecialties: string[] = [];
  let selectedConferences: string[] = [];

  // ì§€ì—­ ë²„íŠ¼ í† ê¸€
  document.querySelectorAll('.region-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const region = btn.getAttribute('data-region')!;
      btn.classList.toggle('bg-mmc-accent/10');
      btn.classList.toggle('border-mmc-accent');

      if (selectedRegions.includes(region)) {
        selectedRegions = selectedRegions.filter(r => r !== region);
      } else {
        selectedRegions.push(region);
      }
    });
  });

  // ì§„ë£Œê³¼ ë²„íŠ¼ í† ê¸€
  document.querySelectorAll('.specialty-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const specialty = btn.getAttribute('data-specialty')!;
      btn.classList.toggle('bg-mmc-accent/10');
      btn.classList.toggle('border-mmc-accent');

      if (selectedSpecialties.includes(specialty)) {
        selectedSpecialties = selectedSpecialties.filter(s => s !== specialty);
      } else {
        selectedSpecialties.push(specialty);
      }
    });
  });

  // í•™íšŒ ë²„íŠ¼ í† ê¸€
  document.querySelectorAll('.conf-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const conf = btn.getAttribute('data-conference')!;
      btn.classList.toggle('bg-purple-100');
      btn.classList.toggle('border-purple-500');

      if (selectedConferences.includes(conf)) {
        selectedConferences = selectedConferences.filter(c => c !== conf);
      } else {
        selectedConferences.push(conf);
      }
    });
  });

  // í¬ë¡¤ë§ ì‹œì‘
  document.getElementById('startCrawlBtn')?.addEventListener('click', async () => {
    if (selectedRegions.length === 0 || selectedSpecialties.length === 0) {
      alert('ì§€ì—­ê³¼ ì§„ë£Œê³¼ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }

    const statusEl = document.getElementById('crawlStatus');
    const statusText = document.getElementById('statusText');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const startBtn = document.getElementById('startCrawlBtn') as HTMLButtonElement;
    const stopBtn = document.getElementById('stopCrawlBtn') as HTMLButtonElement;

    statusEl?.classList.remove('hidden');
    startBtn.disabled = true;
    stopBtn.disabled = false;

    if (statusText) statusText.textContent = `${selectedRegions.join(', ')} - ${selectedSpecialties.join(', ')} í¬ë¡¤ë§ ì¤‘...`;

    // TODO: ì‹¤ì œ API í˜¸ì¶œë¡œ ëŒ€ì²´
    // í˜„ì¬ëŠ” ì‹œë®¬ë ˆì´ì…˜
    let progress = 0;
    const interval = setInterval(() => {
      progress += 10;
      if (progressBar) progressBar.style.width = `${progress}%`;
      if (progressText) progressText.textContent = `${progress}% ì™„ë£Œ`;

      if (progress >= 100) {
        clearInterval(interval);
        if (statusText) statusText.textContent = 'í¬ë¡¤ë§ ì™„ë£Œ!';
        startBtn.disabled = false;
        stopBtn.disabled = true;
      }
    }, 500);
  });

  // í•™íšŒ í¬ë¡¤ë§
  document.getElementById('crawlConferenceBtn')?.addEventListener('click', async () => {
    if (selectedConferences.length === 0) {
      alert('í•™íšŒë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }

    alert(`ì„ íƒëœ í•™íšŒ: ${selectedConferences.join(', ')}\n\ní•™íšŒ í¬ë¡¤ë§ API ì—”ë“œí¬ì¸íŠ¸ê°€ êµ¬í˜„ë˜ë©´ ì‹¤í–‰ë©ë‹ˆë‹¤.`);
  });
</script>
