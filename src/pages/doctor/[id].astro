---
// src/pages/doctor/[id].astro
import Layout from '../../layouts/Layout.astro';
import TierBadge from '../../components/TierBadge.astro';
import TypeBadge from '../../components/TypeBadge.astro';
import RadarChart from '../../components/RadarChart';
import { getD1, getDoctorById } from '../../lib/d1';
import { TIER_INFO, TYPE_INFO } from '../../lib/types';

// SSR 모드 (D1은 런타임 바인딩 필요)
export const prerender = false;

// Cloudflare D1 바인딩
const runtime = Astro.locals.runtime;
const db = getD1(runtime);

const { id } = Astro.params;

// ID가 없으면 404
if (!id) {
  return Astro.redirect('/404');
}

const doctor = await getDoctorById(db, id);

// 샘플 데이터 (DB 연결 전 테스트용)
const sampleDoctor = doctor || {
  id: '1',
  hospital_name: '청담 S클리닉',
  doctor_name: '김명의',
  hospital_url: 'https://example.com',
  region: '청담역',
  specialist_type: '피부과전문의',
  years_of_practice: 18,
  has_fellow: true,
  has_phd: true,
  sci_papers_first: 4,
  sci_papers_co: 3,
  volume_awards: 3,
  trainer_count: 5,
  signature_cases: 10000,
  has_safety_record: true,
  kol_count: 8,
  society_count: 4,
  book_count: 1,
  tier: 'Laureate' as const,
  doctor_type: 'Hexagon' as const,
  total_score: 520,
  foundation_score: 86,
  academic_score: 175,
  clinical_score: 230,
  reputation_score: 29,
  verified_facts: [
    '[학술] SCI 논문 4편 제1저자 (J Dermatol 등)',
    '[학술] 의학박사 (서울대 의대)',
    '[임상] 써마지 FLX 골든레코드 2023',
    '[임상] 울쎄라 다이아몬드 2024',
    '[임상] 라이브서저리 강연 5회',
    '[임상] 18년 무사고 기록',
    '[활동] 앨러간 키닥터 2020-2024',
    '[활동] 멀츠 자문위원',
  ],
  consulting_comment: '모든 영역에서 균형잡힌 완전체(Hexagon) 유형입니다. 학술과 임상 모두에서 최정상급 권위를 인정받고 계십니다.',
  radar_chart_data: { academic: 88, clinical: 92, career: 86, safety: 100, activity: 58 },
  updated_at: '2025-01-19',
};

const tierInfo = TIER_INFO[sampleDoctor.tier];
const typeInfo = TYPE_INFO[sampleDoctor.doctor_type];
---

<Layout title={`${sampleDoctor.doctor_name} 원장`} description={sampleDoctor.consulting_comment}>
  <!-- 뒤로가기 -->
  <a href="/" class="inline-flex items-center gap-1 text-mmc-secondary hover:text-mmc-primary mb-6 text-sm">
    ← TOP 100으로 돌아가기
  </a>

  <!-- 프로필 헤더 -->
  <section class="bg-white border border-mmc-border rounded-lg p-6 md:p-8 mb-6">
    <div class="flex flex-col md:flex-row gap-6">
      <!-- 왼쪽: 기본 정보 -->
      <div class="flex-1">
        <div class="flex items-center gap-3 mb-4">
          <TierBadge tier={sampleDoctor.tier} size="lg" />
          <TypeBadge type={sampleDoctor.doctor_type} />
        </div>

        <h1 class="text-3xl font-bold text-mmc-primary mb-1">{sampleDoctor.doctor_name} 원장</h1>
        <p class="text-mmc-secondary">{sampleDoctor.hospital_name}</p>

        <div class="flex flex-wrap gap-2 mt-4 text-sm text-mmc-secondary">
          <span class="bg-mmc-surface px-3 py-1 rounded-full border border-mmc-border">{sampleDoctor.specialist_type}</span>
          <span class="bg-mmc-surface px-3 py-1 rounded-full border border-mmc-border">{sampleDoctor.region}</span>
          <span class="bg-mmc-surface px-3 py-1 rounded-full border border-mmc-border">경력 {sampleDoctor.years_of_practice}년</span>
          {sampleDoctor.has_phd && <span class="bg-mmc-surface px-3 py-1 rounded-full border border-mmc-border">의학박사</span>}
        </div>

        <!-- 총점 -->
        <div class="mt-6 flex items-end gap-2">
          <span class="text-5xl font-display font-black text-mmc-accent">
            {sampleDoctor.total_score.toLocaleString()}
          </span>
          <span class="text-mmc-secondary mb-2">MMC Score</span>
        </div>

        <p class="mt-4 text-mmc-secondary text-sm italic">"{typeInfo.tagline}"</p>
      </div>

      <!-- 오른쪽: 레이더 차트 -->
      <div class="w-full md:w-72">
        <RadarChart client:load data={sampleDoctor.radar_chart_data} />
      </div>
    </div>
  </section>

  <!-- 점수 상세 -->
  <section class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
    <div class="bg-white border border-mmc-border rounded-lg p-4 text-center">
      <div class="text-2xl font-bold text-emerald-600">{sampleDoctor.foundation_score}</div>
      <div class="text-mmc-secondary text-sm font-medium">Foundation</div>
      <div class="text-mmc-secondary/60 text-xs">기본 자격</div>
    </div>
    <div class="bg-white border border-mmc-border rounded-lg p-4 text-center">
      <div class="text-2xl font-bold text-blue-600">{sampleDoctor.academic_score}</div>
      <div class="text-mmc-secondary text-sm font-medium">Academic</div>
      <div class="text-mmc-secondary/60 text-xs">학술 연구</div>
    </div>
    <div class="bg-white border border-mmc-border rounded-lg p-4 text-center">
      <div class="text-2xl font-bold text-red-600">{sampleDoctor.clinical_score}</div>
      <div class="text-mmc-secondary text-sm font-medium">Clinical</div>
      <div class="text-mmc-secondary/60 text-xs">임상 시술</div>
    </div>
    <div class="bg-white border border-mmc-border rounded-lg p-4 text-center">
      <div class="text-2xl font-bold text-orange-600">{sampleDoctor.reputation_score}</div>
      <div class="text-mmc-secondary text-sm font-medium">Reputation</div>
      <div class="text-mmc-secondary/60 text-xs">대외 활동</div>
    </div>
  </section>

  <!-- AI 컨설팅 코멘트 -->
  <section class="bg-red-50 border border-red-200 rounded-lg p-6 mb-6">
    <h3 class="font-bold mb-2 flex items-center gap-2 text-mmc-primary">
      AI 분석 코멘트
    </h3>
    <p class="text-mmc-secondary">{sampleDoctor.consulting_comment}</p>
  </section>

  <!-- 검증된 팩트 -->
  <section class="bg-white border border-mmc-border rounded-lg p-6">
    <h3 class="font-bold mb-4 flex items-center gap-2 text-mmc-primary">
      검증된 이력 ({sampleDoctor.verified_facts.length}건)
    </h3>
    <ul class="space-y-2">
      {sampleDoctor.verified_facts.map((fact: string) => (
        <li class="flex items-start gap-2 text-sm">
          <span class="text-emerald-600 mt-0.5">✓</span>
          <span class="text-mmc-secondary">{fact}</span>
        </li>
      ))}
    </ul>
  </section>

  <!-- 등급/유형 설명 -->
  <section class="grid md:grid-cols-2 gap-4 mt-6">
    <div class="bg-mmc-surface border border-mmc-border rounded-lg p-5">
      <h4 class="font-semibold mb-2 text-mmc-primary">
        {tierInfo.label} 등급이란?
      </h4>
      <p class="text-mmc-secondary text-sm">
        {tierInfo.label === 'Laureate' && '500점 이상. 학술과 임상 모두에서 독보적인 업적을 이룬 최고의 권위자입니다.'}
        {tierInfo.label === 'Authority' && '350점 이상. 해당 분야의 트렌드를 주도하고 학술적 영향력이 큰 전문가입니다.'}
        {tierInfo.label === 'Master' && '200점 이상. 풍부한 임상 경험과 검증된 학술 역량을 갖춘 숙련의입니다.'}
        {tierInfo.label === 'Diplomate' && '100점 이상. 전문의 자격을 바탕으로 기본 이상의 역량을 검증받은 의료인입니다.'}
      </p>
    </div>
    <div class="bg-mmc-surface border border-mmc-border rounded-lg p-5">
      <h4 class="font-semibold mb-2 text-mmc-primary">
        {typeInfo.labelKo} 유형이란?
      </h4>
      <p class="text-mmc-secondary text-sm">{typeInfo.tagline}</p>
      <p class="text-mmc-secondary/60 text-xs mt-2">추천 대상: {
        typeInfo.label === 'Scholar' ? '안전하고 검증된 시술을 원하는 분' :
        typeInfo.label === 'Maestro' ? '효과와 테크닉을 중시하는 분' :
        typeInfo.label === 'Pioneer' ? '최신 유행 시술을 원하는 분' :
        typeInfo.label === 'Guardian' ? '평생 주치의를 찾는 분' :
        '국내 최고 권위자를 원하는 분'
      }</p>
    </div>
  </section>

  <!-- JSON-LD: Physician Schema for AI/SEO -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "Physician",
    "name": `${sampleDoctor.doctor_name} 원장`,
    "givenName": sampleDoctor.doctor_name,
    "medicalSpecialty": {
      "@type": "MedicalSpecialty",
      "name": sampleDoctor.specialist_type
    },
    "jobTitle": sampleDoctor.specialist_type,
    "worksFor": {
      "@type": "MedicalClinic",
      "name": sampleDoctor.hospital_name,
      "address": {
        "@type": "PostalAddress",
        "addressLocality": sampleDoctor.region,
        "addressCountry": "KR"
      },
      "url": sampleDoctor.hospital_url
    },
    "description": sampleDoctor.consulting_comment,
    "knowsAbout": [
      sampleDoctor.specialist_type,
      "피부 시술",
      "레이저 치료",
      "필러",
      "보톡스"
    ],
    "hasCredential": [
      sampleDoctor.has_phd && {
        "@type": "EducationalOccupationalCredential",
        "credentialCategory": "의학박사",
        "name": "의학박사 (PhD)"
      },
      {
        "@type": "EducationalOccupationalCredential",
        "credentialCategory": "전문의",
        "name": sampleDoctor.specialist_type
      }
    ].filter(Boolean),
    "award": sampleDoctor.verified_facts.filter((f: string) => f.includes('[임상]') || f.includes('[활동]')),
    "aggregateRating": {
      "@type": "AggregateRating",
      "ratingValue": sampleDoctor.total_score,
      "bestRating": 1000,
      "worstRating": 0,
      "ratingExplanation": `MadMedCheck MMC Score - ${tierInfo.label} 등급 (${typeInfo.labelKo} 유형). SCI 논문, 제조사 인증, 학회 활동 등 제3자 검증 데이터 기반 평가.`
    }
  })} />

  <!-- JSON-LD: MedicalWebPage for additional context -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "MedicalWebPage",
    "name": `${sampleDoctor.doctor_name} 원장 - ${sampleDoctor.hospital_name}`,
    "description": `${sampleDoctor.doctor_name} ${sampleDoctor.specialist_type}의 MMC Score ${sampleDoctor.total_score}점. ${sampleDoctor.consulting_comment}`,
    "about": {
      "@type": "Physician",
      "name": sampleDoctor.doctor_name
    },
    "specialty": sampleDoctor.specialist_type,
    "lastReviewed": new Date().toISOString().split('T')[0],
    "reviewedBy": {
      "@type": "Organization",
      "name": "MadMedCheck",
      "description": "AI 기반 의료인 검증 시스템"
    },
    "mainContentOfPage": {
      "@type": "WebPageElement",
      "cssSelector": "article"
    }
  })} />
</Layout>
