---
// src/pages/doctor/[id].astro
// 인명사전 스타일 - 의료인 상세 프로필
import Layout from '../../layouts/Layout.astro';
import RadarChart from '../../components/RadarChart';
import { getD1, getDoctorById } from '../../lib/d1';
import { TYPE_INFO } from '../../lib/types';

// SSR 모드 (D1은 런타임 바인딩 필요)
export const prerender = false;

// Cloudflare D1 바인딩
const runtime = Astro.locals.runtime;
const db = getD1(runtime);

const { id } = Astro.params;

// ID가 없으면 404
if (!id) {
  return Astro.redirect('/404');
}

const doctor = await getDoctorById(db, id);

// 데이터가 없으면 404
if (!doctor) {
  return Astro.redirect('/404');
}

const typeInfo = TYPE_INFO[doctor.doctor_type];

// 레이더 데이터에서 강점 영역들 추출
const strengthAreas = [
  { key: 'academic', label: '학술 연구', value: doctor.radar_chart_data.academic, color: 'blue' },
  { key: 'clinical', label: '임상 경험', value: doctor.radar_chart_data.clinical, color: 'green' },
  { key: 'career', label: '경력', value: doctor.radar_chart_data.career, color: 'amber' },
  { key: 'safety', label: '안전 기록', value: doctor.radar_chart_data.safety, color: 'emerald' },
  { key: 'activity', label: '학회 활동', value: doctor.radar_chart_data.activity, color: 'purple' },
].sort((a, b) => b.value - a.value);

const topStrength = strengthAreas[0];
const strengthDescription = {
  'academic': '학술 연구에 강점을 가진',
  'clinical': '임상 경험이 풍부한',
  'career': '오랜 경력을 갖춘',
  'safety': '안전한 시술을 추구하는',
  'activity': '활발한 학회 활동을 하는',
}[topStrength.key] || '';

// 검증된 팩트 카테고리별 분류
const factsByCategory = {
  학술: doctor.verified_facts.filter((f: string) => f.includes('[학술]')),
  임상: doctor.verified_facts.filter((f: string) => f.includes('[임상]')),
  활동: doctor.verified_facts.filter((f: string) => f.includes('[활동]')),
};
---

<Layout title={`${doctor.doctor_name} - 검증된 의료인`} description={doctor.consulting_comment}>
  <!-- 뒤로가기 -->
  <a href="/" class="inline-flex items-center gap-1 text-mmc-secondary hover:text-mmc-primary mb-6 text-sm">
    ← 인명부로 돌아가기
  </a>

  <!-- 프로필 헤더 -->
  <section class="bg-white border border-mmc-border rounded-lg p-6 md:p-8 mb-6">
    <div class="flex flex-col md:flex-row gap-6">
      <!-- 왼쪽: 기본 정보 -->
      <div class="flex-1">
        <h1 class="text-3xl font-bold text-mmc-primary mb-1">
          {doctor.doctor_name}
          <span class="text-lg font-normal text-mmc-secondary ml-2">{doctor.specialist_type}</span>
        </h1>
        {doctor.english_name && (
          <p class="text-mmc-secondary text-sm mb-2">{doctor.english_name}</p>
        )}
        <p class="text-mmc-secondary">{doctor.hospital_name}</p>

        <div class="flex flex-wrap gap-2 mt-4 text-sm text-mmc-secondary">
          <span class="bg-mmc-surface px-3 py-1 rounded-full border border-mmc-border">{doctor.region}</span>
          <span class="bg-mmc-surface px-3 py-1 rounded-full border border-mmc-border">경력 {doctor.years_of_practice}년</span>
          {doctor.has_phd && <span class="bg-mmc-surface px-3 py-1 rounded-full border border-mmc-border">의학박사</span>}
          {doctor.has_fellow && <span class="bg-mmc-surface px-3 py-1 rounded-full border border-mmc-border">펠로우 수료</span>}
        </div>

        <!-- 강점 설명 -->
        <div class="mt-6 p-4 bg-mmc-surface rounded-lg border border-mmc-border">
          <p class="text-mmc-accent font-medium">
            {strengthDescription} {doctor.specialist_type}
          </p>
          <p class="text-mmc-secondary text-sm mt-1">{doctor.consulting_comment}</p>
        </div>
      </div>

      <!-- 오른쪽: 레이더 차트 -->
      <div class="w-full md:w-72">
        <RadarChart client:load data={doctor.radar_chart_data} />
      </div>
    </div>
  </section>

  <!-- 역량 게이지 (점수 대신 시각적 게이지) -->
  <section class="bg-white border border-mmc-border rounded-lg p-6 mb-6">
    <h3 class="font-bold mb-4 text-mmc-primary">역량 분포</h3>
    <div class="space-y-4">
      {strengthAreas.map((area) => (
        <div>
          <div class="flex justify-between mb-1">
            <span class="text-sm font-medium text-mmc-secondary">{area.label}</span>
            <span class="text-xs text-mmc-secondary">
              {area.value >= 80 ? '매우 높음' : area.value >= 60 ? '높음' : area.value >= 40 ? '보통' : area.value >= 20 ? '기본' : '-'}
            </span>
          </div>
          <div class="h-3 bg-mmc-border rounded-full overflow-hidden">
            <div
              class={`h-full rounded-full transition-all duration-500 ${
                area.color === 'blue' ? 'bg-blue-500' :
                area.color === 'green' ? 'bg-green-500' :
                area.color === 'amber' ? 'bg-amber-500' :
                area.color === 'emerald' ? 'bg-emerald-500' :
                'bg-purple-500'
              }`}
              style={`width: ${area.value}%`}
            ></div>
          </div>
        </div>
      ))}
    </div>
  </section>

  <!-- 검증된 이력 (카테고리별) -->
  <section class="bg-white border border-mmc-border rounded-lg p-6 mb-6">
    <h3 class="font-bold mb-4 text-mmc-primary">
      검증된 이력 ({doctor.verified_facts.length}건)
    </h3>

    <div class="space-y-6">
      {factsByCategory.학술.length > 0 && (
        <div>
          <h4 class="text-sm font-semibold text-blue-600 mb-2 flex items-center gap-2">
            <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
            학술 연구
          </h4>
          <ul class="space-y-1.5 ml-4">
            {factsByCategory.학술.map((fact: string) => (
              <li class="text-sm text-mmc-secondary flex items-start gap-2">
                <span class="text-emerald-600 mt-0.5">✓</span>
                <span>{fact.replace('[학술] ', '')}</span>
              </li>
            ))}
          </ul>
        </div>
      )}

      {factsByCategory.임상.length > 0 && (
        <div>
          <h4 class="text-sm font-semibold text-green-600 mb-2 flex items-center gap-2">
            <span class="w-2 h-2 bg-green-500 rounded-full"></span>
            임상 경험
          </h4>
          <ul class="space-y-1.5 ml-4">
            {factsByCategory.임상.map((fact: string) => (
              <li class="text-sm text-mmc-secondary flex items-start gap-2">
                <span class="text-emerald-600 mt-0.5">✓</span>
                <span>{fact.replace('[임상] ', '')}</span>
              </li>
            ))}
          </ul>
        </div>
      )}

      {factsByCategory.활동.length > 0 && (
        <div>
          <h4 class="text-sm font-semibold text-purple-600 mb-2 flex items-center gap-2">
            <span class="w-2 h-2 bg-purple-500 rounded-full"></span>
            학회 및 대외 활동
          </h4>
          <ul class="space-y-1.5 ml-4">
            {factsByCategory.활동.map((fact: string) => (
              <li class="text-sm text-mmc-secondary flex items-start gap-2">
                <span class="text-emerald-600 mt-0.5">✓</span>
                <span>{fact.replace('[활동] ', '')}</span>
              </li>
            ))}
          </ul>
        </div>
      )}
    </div>
  </section>

  <!-- 데이터 출처 안내 -->
  <section class="bg-mmc-surface border border-mmc-border rounded-lg p-5">
    <h4 class="font-semibold mb-2 text-mmc-primary text-sm">데이터 출처 안내</h4>
    <p class="text-mmc-secondary text-xs">
      본 정보는 PubMed 논문 데이터, 제조사 공식 인증 기록, 학회 발표 자료 등 제3자 검증이 가능한
      객관적 데이터만을 기반으로 합니다. 자기 주장 데이터는 포함되지 않습니다.
    </p>
    <p class="text-mmc-secondary/60 text-xs mt-2">
      마지막 업데이트: {new Date(doctor.updated_at).toLocaleDateString('ko-KR')}
    </p>
  </section>

  <!-- JSON-LD: Physician Schema for AI/SEO -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "Physician",
    "name": doctor.doctor_name,
    "givenName": doctor.doctor_name,
    "alternateName": doctor.english_name,
    "medicalSpecialty": {
      "@type": "MedicalSpecialty",
      "name": doctor.specialist_type
    },
    "jobTitle": doctor.specialist_type,
    "worksFor": {
      "@type": "MedicalClinic",
      "name": doctor.hospital_name,
      "address": {
        "@type": "PostalAddress",
        "addressLocality": doctor.region,
        "addressCountry": "KR"
      },
      "url": doctor.hospital_url
    },
    "description": doctor.consulting_comment,
    "knowsAbout": [
      doctor.specialist_type,
      "피부 시술",
      "레이저 치료"
    ],
    "hasCredential": [
      doctor.has_phd && {
        "@type": "EducationalOccupationalCredential",
        "credentialCategory": "의학박사",
        "name": "의학박사 (PhD)"
      },
      {
        "@type": "EducationalOccupationalCredential",
        "credentialCategory": "전문의",
        "name": doctor.specialist_type
      }
    ].filter(Boolean),
    "award": doctor.verified_facts.filter((f: string) => f.includes('[임상]') || f.includes('[활동]'))
  })} />

  <!-- JSON-LD: MedicalWebPage for additional context -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "MedicalWebPage",
    "name": `${doctor.doctor_name} - ${doctor.hospital_name}`,
    "description": `${doctor.doctor_name} ${doctor.specialist_type}. ${doctor.consulting_comment}`,
    "about": {
      "@type": "Physician",
      "name": doctor.doctor_name
    },
    "specialty": doctor.specialist_type,
    "lastReviewed": new Date().toISOString().split('T')[0],
    "reviewedBy": {
      "@type": "Organization",
      "name": "MadMedCheck",
      "description": "제3자 검증 기반 의료인 정보 서비스"
    }
  })} />
</Layout>
